groups:
  - name: Linuxä¸»æœºçŠ¶æ€-ç›‘æ§å‘Šè­¦
    rules:
    - alert: ç›‘æ§ç›®æ ‡ä¸å¯è¾¾
      expr: up == 0
      for: 1m
      labels:
        severity: critical
        for_time: 1m
      annotations:
        summary: "{{- if $labels.hostname }}{{ $labels.hostname }} {{ end }}{{ $labels.instance }} ç›‘æ§ç›®æ ‡å¤±è”"
        description: |-
          ğŸš¨ **ç›‘æ§ç›®æ ‡ä¸å¯è¾¾**
          - å®ä¾‹ï¼š{{- if $labels.hostname }}{{ $labels.hostname }} {{ end }}{{ $labels.instance }}
          - å¯èƒ½åŸå› ï¼šæœåŠ¡å´©æºƒ / ç½‘ç»œä¸­æ–­
          - ğŸ” å»ºè®®è¯Šæ–­ï¼š`curl http://{{ $labels.instance }}:{{ $labels.__metrics_path__ }}`

    - alert: ä¸»æœºcpuè´Ÿè½½é«˜
      expr: |
        (1 - avg by (instance) (
          rate(node_cpu_seconds_total{mode="idle"}[5m])
        )) * 100 > 80
      for: 5m
      labels:
        severity: warning
        for_time: 5m
        threshold: "80%"
      annotations:
        summary: "{{- if $labels.hostname }}{{ $labels.hostname }} {{ end }}{{ $labels.instance }} ä¸»æœº CPU è´Ÿè½½é«˜"
        description: |-
          âš ï¸ **CPU è´Ÿè½½æŒç»­é«˜äº 80%**
          - å®ä¾‹ï¼š{{- if $labels.hostname }}{{ $labels.hostname }} {{ end }}{{ $labels.instance }}
          - å½“å‰ CPU ä½¿ç”¨ç‡ï¼š{{ printf "%.1f%%" $value }}
          - ğŸ” å»ºè®®è¯Šæ–­ï¼š`top -n1 -b`
          
    - alert: ä¸»æœºå†…å­˜ä¸è¶³
      expr: |
        node_memory_MemAvailable_bytes < 3 * 1024 * 1024 * 1024  # å°äº3GB
        and
        (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 < 20
      for: 2m
      labels:
        severity: warning
        for_time: 2m
        threshold: "20% ä¸” < 3GB"
      annotations:
        summary: "{{- if $labels.hostname }}{{ $labels.hostname }} {{ end }}{{ $labels.instance }} ä¸»æœºå†…å­˜ä¸è¶³"
        description: |-
          âš ï¸ **å¯ç”¨å†…å­˜ä½äº 20% ä¸”å°äº 3GB**
          - å®ä¾‹ï¼š{{- if $labels.hostname }}{{ $labels.hostname }} {{ end }}{{ $labels.instance }}
          - å½“å‰å†…å­˜å¯ç”¨ï¼š{{ humanize $value }}
          - ğŸ” å»ºè®®è¯Šæ–­ï¼š`free -m`

    - alert: ä¸»æœºç£ç›˜ç©ºé—´ä¸è¶³
      expr: |
        (
          node_filesystem_avail_bytes{fstype!~"^(fuse.*|tmpfs|cifs|nfs)"} < 20 * 1024 * 1024 * 1024  # å°‘äº20GB
          and
          node_filesystem_avail_bytes{fstype!~"^(fuse.*|tmpfs|cifs|nfs)"} / node_filesystem_size_bytes * 100 < 20
        )
        and on (instance, device, mountpoint) node_filesystem_readonly == 0
      for: 2m
      labels:
        severity: critical
        for_time: 2m
        threshold: "20% ä¸” < 20GB"
      annotations:
        summary: "{{- if $labels.hostname }}{{ $labels.hostname }} {{ end }}{{ $labels.instance }} ç£ç›˜ç©ºé—´ä¸è¶³"
        description: |-
          ğŸš¨ **ç£ç›˜å‰©ä½™ç©ºé—´å°‘äº 20% ä¸”ä½äº 20GB**
          - å®ä¾‹ï¼š{{- if $labels.hostname }}{{ $labels.hostname }} {{ end }}{{ $labels.instance }}
          - æŒ‚è½½ç‚¹ï¼š{{ $labels.mountpoint }}
          - æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼š{{ $labels.fstype }}
          - å½“å‰ç£ç›˜å¯ç”¨ï¼š{{ humanize $value }}
          - ğŸ” å»ºè®®è¯Šæ–­ï¼š`df -h {{ $labels.mountpoint }}`

    - alert: ä¸»æœºç£ç›˜ioå¼‚å¸¸
      expr: |
        rate(node_disk_io_time_seconds_total[5m]) > 0.8
      for: 5m
      labels:
        severity: warning
        for_time: 5m
        threshold: "80%"
      annotations:
        summary: "{{- if $labels.hostname }}{{ $labels.hostname }} {{ end }}{{ $labels.instance }} ç£ç›˜ IO ä½¿ç”¨ç‡è¿‡é«˜ï¼"
        description: |-
          âš ï¸ **ç£ç›˜ IO è´Ÿè½½é«˜**
          - å®ä¾‹ï¼š{{- if $labels.hostname }}{{ $labels.hostname }} {{ end }}{{ $labels.instance }}
          - è®¾å¤‡ï¼š{{ $labels.device }}
          - å½“å‰ IO ä½¿ç”¨ç‡ï¼š{{ printf "%.0f%%" $value }}
          - ğŸ” å»ºè®®è¯Šæ–­ï¼š`iostat -x 1`

    - alert: ç½‘ç»œæµå…¥å¸¦å®½è¿‡è½½
      expr: |
        (
          rate(node_network_receive_bytes_total[5m]) /
          on(instance, device) node_network_speed_bytes
        ) * 100 > 80
      for: 1m
      labels:
        severity: warning
        for_time: 1m
        threshold: "80%"
      annotations:
        summary: "{{- if $labels.hostname }}{{ $labels.hostname }} {{ end }}{{ $labels.instance }} æµå…¥å¸¦å®½è¶…è¿‡ 80% è´Ÿè½½ï¼"
        description: |-
          âš ï¸ **ç½‘ç»œæµå…¥å¸¦å®½è¿‡è½½**
          - å®ä¾‹ï¼š{{- if $labels.hostname }}{{ $labels.hostname }} {{ end }}{{ $labels.instance }}
          - æ¥å£ï¼š{{ $labels.device }}
          - å½“å‰å¸¦å®½å ç”¨ï¼š{{ printf "%.1f%%" $value }}

    - alert: ç½‘ç»œæµå‡ºå¸¦å®½è¿‡è½½
      expr: |
        (
          rate(node_network_transmit_bytes_total[5m]) /
          on(instance, device) node_network_speed_bytes
        ) * 100 > 80
      for: 1m
      labels:
        severity: warning
        for_time: 1m
        threshold: "80%"
      annotations:
        summary: "{{- if $labels.hostname }}{{ $labels.hostname }} {{ end }}{{ $labels.instance }} æµå‡ºå¸¦å®½è¶…è¿‡ 80% è´Ÿè½½ï¼"
        description: |-
          âš ï¸ **ç½‘ç»œæµå‡ºå¸¦å®½è¿‡è½½**
          - å®ä¾‹ï¼š{{- if $labels.hostname }}{{ $labels.hostname }} {{ end }}{{ $labels.instance }}
          - æ¥å£ï¼š{{ $labels.device }}
          - å½“å‰å¸¦å®½å ç”¨ï¼š{{ printf "%.1f%%" $value }}

  - name: optimized_record_rules
    interval: 1m
    rules:
    - record: node:cpu:usage:1m
      expr: |
        (1 - avg by(instance)(
          rate(node_cpu_seconds_total{mode="idle"}[1m])
        )) * 100
    - record: node:mem:usage:1m
      expr: |
        (1 - node_memory_MemAvailable_bytes /
        node_memory_MemTotal_bytes) * 100
