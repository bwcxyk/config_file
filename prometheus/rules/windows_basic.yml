groups:
  - name: Windows主机状态-监控告警
    rules:
    - alert: WindowsServerCollectorError
      expr: windows_exporter_collector_success == 0
      for: 1m
      labels:
        severity: critical
        for_time: 1m
      annotations:
        summary: "{{ $labels.instance }} 监控目标失联"
        description: |-
          🚨 **监控目标不可达**
          - 实例：{{- if $labels.hostname }}{{ $labels.hostname }} {{ end }}{{ $labels.instance }}
          - 可能原因：服务崩溃 / 网络中断

    - alert: WindowsServerCpuUsage
      expr: |
        (1 - avg by (instance) (
          rate(windows_cpu_time_total{mode="idle"}[5m])
        )) * 100 > 80
      for: 5m
      labels:
        severity: warning
        for_time: 5m
        threshold: "80%"
      annotations:
        summary: "{{ $labels.instance }} 主机 CPU 负载高"
        description: |-
          ⚠️ **CPU 负载持续高于 80%**
          - 实例：{{ $labels.instance }}
          - 当前 CPU 使用率：{{ printf "%.1f%%" $value }}

    - alert: WindowsServerMemoryUsage
      expr: |
        windows_os_physical_memory_free_bytes < 3 * 1024 * 1024 * 1024
        and
        (windows_os_physical_memory_free_bytes / windows_cs_physical_memory_bytes) * 100 < 20
      for: 2m
      labels:
        severity: warning
        for_time: 2m
        threshold: "20% 且 < 3GB"
      annotations:
        summary: "{{ $labels.instance }} 主机内存不足"
        description: |-
          ⚠️ **可用内存低于 20% 且小于 3GB**
          - 实例：{{ $labels.instance }}
          - 当前内存可用：{{ humanize $value }}

    - alert: WindowsServerDiskSpaceUsage
      expr: |
        (
          windows_logical_disk_free_bytes < 20 * 1024 * 1024 * 1024
          and
          (windows_logical_disk_free_bytes / windows_logical_disk_size_bytes * 100) < 20
        )
      for: 2m
      labels:
        severity: critical
        for_time: 2m
        threshold: "20% 且 < 20GB"
      annotations:
        summary: "{{ $labels.instance }} 磁盘空间不足"
        description: |-
          🚨 **磁盘剩余空间少于 20%且剩余空间低于 20GB**
          - 实例：{{ $labels.instance }}
          - 磁盘卷：{{ $labels.volume }}
          - 剩余空间：{{ humanize $value }}

    - alert: 网络流入带宽过载
      expr: (irate(windows_net_bytes_received_total{nic!~'isatap.*|VPN.*'}[5m])*8 /1000/1000) > 8
      for: 1m
      labels:
        severity: warning
        for_time: 1m
        threshold: "8Mbps"
      annotations:
        summary: "{{ $labels.instance }} 流入（下载）网络带宽过高！"
        description: |-
          ⚠️ **网络流入带宽过载**
          - 实例：{{ $labels.instance }}
          - 接口：{{ $labels.device }}
          - 当前带宽占用：{{ printf "%.2f Mbps" $value }}

    - alert: 网络流出带宽过载
      expr: (irate(windows_net_bytes_sent_total{nic!~'isatap.*|VPN.*'}[5m])*8 /1000/1000) > 8
      for: 1m
      labels:
        severity: warning
        for_time: 1m
        threshold: "8Mbps"
      annotations:
        summary: "{{ $labels.instance }} 流出（上传）网络带宽过高！"
        description: |-
          ⚠️ **网络流出带宽过载**
          - 实例：{{- if $labels.hostname }}{{ $labels.hostname }} {{ end }}{{ $labels.instance }}
          - 接口：{{ $labels.device }}
          - 当前带宽占用：{{ printf "%.2f Mbps" $value }}
